<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Tarefas Flexpro</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%228%22 fill=%22%23007bff%22/><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2230%22>PG</text></svg>">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 400px; }
        h2 { text-align: center; color: #333; }
        .input-group { display: flex; gap: 5px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-test { background-color: #007bff; width: 100%; margin-top: 10px; }
        ul { list-style-type: none; padding: 0; }
        li { background: #eee; margin: 5px 0; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #007bff; }
        .delete-btn { background-color: #dc3545; padding: 5px 10px; font-size: 12px; margin-left: 10px; }
        .status { font-size: 11px; color: #666; text-align: center; margin-top: 10px; border-top: 1px solid #eee; padding-top:5px;}
    </style>
</head>
<body>

<div class="container">
    <h2>Pendências Flexpro</h2>
    <div class="input-group">
        <input type="text" id="inputTarefa" placeholder="Nova pendência para a equipe...">
        <button class="btn-add" onclick="adicionarTarefa()">Salvar</button>
    </div>
    
    <ul id="listaTarefas">
        <li style="text-align:center; color:#888;">A carregar lista da nuvem...</li>
    </ul>

    <div class="status" id="statusSistema">Conectando ao Google...</div>
    <button class="btn-test" onclick="forcarEnvioTeste()">Enviar Agora</button>
</div>

<audio id="somAlerta" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // -------------------------------------------------------
    // 1. CONFIGURAÇÕES
    // -------------------------------------------------------

    // A) EMAILJS
    const EMAIL_SERVICE_ID = "service_9kks8zg";
    const EMAIL_TEMPLATE_ID = "template_6a9ug9r";
    const EMAIL_PUBLIC_KEY = "-da-dOnAwbnwjB6NB";
    const EMAILS_DESTINO = "paulo@Flexpro.com.br, glauber@Flexpro.com.br";

    // B) FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDQ8-KLCRRFFpW631LKj2r2ZX7B7QSpQ-I",
      authDomain: "notas-homologacoes.firebaseapp.com",
      projectId: "notas-homologacoes",
      storageBucket: "notas-homologacoes.firebasestorage.app",
      messagingSenderId: "480356280692",
      appId: "1:480356280692:web:12b80642a99d70c5ef6421",
      measurementId: "G-NKTW2HLK54"
    };

    // -------------------------------------------------------
    // 2. INICIALIZAÇÃO
    // -------------------------------------------------------
    
    (function() { emailjs.init(EMAIL_PUBLIC_KEY); })();

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();

    // -------------------------------------------------------
    // 3. LÓGICA SINCRONIZADA
    // -------------------------------------------------------

    const listaRef = database.ref('tarefas');
    
    listaRef.on('value', (snapshot) => {
        const lista = document.getElementById('listaTarefas');
        lista.innerHTML = ''; 
        const dados = snapshot.val();

        if (dados) {
            Object.keys(dados).forEach((key) => {
                const tarefa = dados[key];
                const li = document.createElement('li');
                li.innerHTML = `
                    ${tarefa} 
                    <button class="delete-btn" onclick="removerTarefa('${key}')">X</button>
                `;
                lista.appendChild(li);
            });
            document.getElementById("statusSistema").innerText = "Sincronizado com a nuvem.";
        } else {
            lista.innerHTML = '<li style="text-align:center">Nenhuma pendência.</li>';
            document.getElementById("statusSistema").innerText = "Lista vazia.";
        }
    });

    function adicionarTarefa() {
        const input = document.getElementById('inputTarefa');
        const texto = input.value;
        if (texto === '') { alert("Escreva algo!"); return; }

        database.ref('tarefas').push(texto);
        input.value = ''; 
        input.focus(); 
    }

    function removerTarefa(key) {
        database.ref('tarefas').child(key).remove();
    }

    // -------------------------------------------------------
    // 4. SISTEMA DE AVISOS E EVENTOS
    // -------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        pedirPermissaoNotificacao();
        setInterval(verificarHorarioFixo, 60000); 

        // ATIVAR O ENTER
        const input = document.getElementById("inputTarefa");
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); 
                adicionarTarefa(); 
            }
        });
    });

    function pedirPermissaoNotificacao() {
        if ("Notification" in window) Notification.requestPermission();
    }

    function tocarSom() {
        document.getElementById("somAlerta").play().catch(e => console.log("Som pendente de interação."));
    }

    function pegarTarefasEEnviar() {
        database.ref('tarefas').once('value').then((snapshot) => {
            const dados = snapshot.val();
            if (dados) {
                const listaTarefas = Object.values(dados);
                enviarEmail(listaTarefas);
            }
        });
    }

    // --- CORREÇÃO FEITA AQUI (FORMATAÇÃO DA LISTA) ---
    function enviarEmail(tarefasArray) {
        // .map adiciona "- " na frente de CADA item
        // .join pula linha depois de cada item
        const listaFormatada = tarefasArray.map(item => "- " + item).join("\n");

        const params = {
            to_email: EMAILS_DESTINO,
            message: listaFormatada,
            time: new Date().toLocaleTimeString()
        };

        document.getElementById("statusSistema").innerText = "Enviando e-mail...";
        
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params)
            .then(() => {
                document.getElementById("statusSistema").innerText = "E-mail enviado!";
            });
    }

    function verificarHorarioFixo() {
        const agora = new Date();
        const hora = agora.getHours(); 
        const idHoraHoje = agora.toLocaleDateString().replace(/\//g,'-') + '-' + hora;

        if (hora === 10 || hora === 16) {
            database.ref('controle_envios').child(idHoraHoje).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('tarefas').once('value', (tks) => {
                        if (tks.exists()) {
                            console.log("Sou o primeiro a verificar. Enviando...");
                            tocarSom();
                            if (Notification.permission === "granted") new Notification("Aviso Pendências!");
                            
                            const lista = Object.values(tks.val());
                            enviarEmail(lista);

                            database.ref('controle_envios').child(idHoraHoje).set(true);
                        }
                    });
                } else {
                    console.log("O e-mail das " + hora + "h já foi enviado por outro computador.");
                }
            });
        }
    }

    function forcarEnvioTeste() {
        tocarSom();
        pegarTarefasEEnviar();
        alert("Disparo manual iniciado.");
    }

</script>
</body>
</html>